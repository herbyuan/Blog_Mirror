<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Socket编程基础 | H的部落阁</title><meta name="author" content="Herbert"><meta name="copyright" content="Herbert"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Socket编程基础 简单来说, socket 可以看作网络中通信的方式, 虽然它也可以作为本地通信的方式 (比如Unix Socket). 跳过网上随处可见的介绍, 这里只强调一下 socket 位于应用层和传输层之间, 也就是说, socket 封装的是 TCP&#x2F;IP 的数据包 (所以 socket 需要手动处理例如 TCP 三次握手之类的请求), 接口直接面向用户 (也就是进程直接把配置好的">
<meta property="og:type" content="article">
<meta property="og:title" content="Socket编程基础">
<meta property="og:url" content="https://www.zhuoyuan-he.cn/Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="H的部落阁">
<meta property="og:description" content="Socket编程基础 简单来说, socket 可以看作网络中通信的方式, 虽然它也可以作为本地通信的方式 (比如Unix Socket). 跳过网上随处可见的介绍, 这里只强调一下 socket 位于应用层和传输层之间, 也就是说, socket 封装的是 TCP&#x2F;IP 的数据包 (所以 socket 需要手动处理例如 TCP 三次握手之类的请求), 接口直接面向用户 (也就是进程直接把配置好的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.zhuoyuan-he.cn/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)">
<meta property="article:published_time" content="2024-01-24T08:51:13.000Z">
<meta property="article:modified_time" content="2024-01-24T13:59:10.803Z">
<meta property="article:author" content="Herbert">
<meta property="article:tag" content="C++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.zhuoyuan-he.cn/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.zhuoyuan-he.cn/Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Socket编程基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-24 21:59:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/imgs/selfie.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">H的部落阁</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Socket编程基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-24T08:51:13.000Z" title="发表于 2024-01-24 16:51:13">2024-01-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-24T13:59:10.803Z" title="更新于 2024-01-24 21:59:10">2024-01-24</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>Socket编程基础</h1>
<p>简单来说, <code>socket</code> 可以看作网络中通信的方式, 虽然它也可以作为本地通信的方式 (比如<code>Unix Socket</code>). 跳过网上随处可见的介绍, 这里只强调一下 <code>socket</code> 位于应用层和传输层之间, 也就是说, <code>socket</code> 封装的是 <code>TCP/IP</code> 的数据包 (所以 <code>socket</code> 需要手动处理例如 <code>TCP</code> 三次握手之类的请求), 接口直接面向用户 (也就是进程直接把配置好的 <code>socket</code> 当做 IO 使用). 网上的教程和实例代码随便找有一大堆, 所以我来讲讲 <code>windows</code> 下的 <code>socket</code> 编程.</p>
<h2 id="echo-客户端与服务器">echo 客户端与服务器</h2>
<p>在这部分我们试图实现一个最简单的 <code>socket</code> 通信 server 与 client. server 总是返回 client 发送的相同内容.</p>
<h3 id="Server">Server</h3>
<p>最简单的例子就是这个, 服务端建立一个套接字在端口上监听, 等待客户端连接后 <code>echo</code> 客户端发来的所有内容. 开始之前我们仍然复习一下这张流程图.</p>
<p><img src="socket1.png" alt="socket 通信流程"></p>
<p>先来说一下头文件, 在 <code>Linux</code> 中, 网络编程的头文件一般需要引入 <code>arpa/inet.h</code> 和 <code>sys/socket.h</code> (回头我测一下补上), 但是 <code>windows</code> 下不太一样. 而且 <code>windows</code> 的库需要显式初始化 所以最简单的预生成文件写法如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _WIN32</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment (lib, <span class="string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize Winsock</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="type">int</span> iResult = <span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>,<span class="number">2</span>), &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于服务器来说, 建立一个 <code>socket</code> 需要知道在什么地址的哪个端口上监听请求, 以及这个地址是 <code>ipv4</code> 还是 <code>ipv6</code>, 通讯的协议是 <code>TCP</code> 还是 <code>UDP</code> 还是其他什么, 有了这些信息我们才能构建好一个 <code>socket</code>. 结构体 <code>addrinfo</code> 完全包含了创建 <code>socket</code> 所需要的所有信息, 我们可以通过一个 <code>addrinfo</code> 创建 <code>socket</code>. <code>getaddrinfo</code> 函数提供从 ANSI 主机名到地址的与协议无关的转换, 通过提供有关调用方支持的套接字类型的提示, 由这个函数返回指向包含有关主机的响应信息的一个或多个 <code>addrinfo</code> 结构的链接列表的指针.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INT WSAAPI <span class="title">getaddrinfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PCSTR           pNodeName,     <span class="comment">// 主机 (节点) 名称或数字主机地址字符串</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PCSTR           pServiceName,  <span class="comment">// 该字符串包含表示为字符串的服务名称或端口号</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] <span class="type">const</span> ADDRINFOA *pHints,       <span class="comment">// 该结构提供有关调用方支持的套接字类型的提示</span></span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PADDRINFOA      *ppResult      <span class="comment">// 指向包含有关主机的响应信息的一个或多个 addrinfo 结构的链接列表的指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>
<p>可以看出, 我们需要向函数提供指向两个 <code>addrinfo</code> 的指针, 意味着使用完后记得使用 <code>freeaddrinfo()</code> 释放对应资源以免造成内存泄漏. 有了完整的 <code>addrinfo</code>, 我们就可以创建一个 <code>socket</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a SOCKET for the server to listen for client connections.</span></span><br><span class="line">ListenSocket = <span class="built_in">socket</span>(result-&gt;ai_family, result-&gt;ai_socktype, result-&gt;ai_protocol);</span><br><span class="line"><span class="keyword">if</span> (ListenSocket == INVALID_SOCKET) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;socket failed with error: %ld\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    <span class="built_in">freeaddrinfo</span>(result);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到, 创建 <code>socket</code> 只是指定了通讯的协议, 而与地址或端口无关, 下一步才是绑定端口, 并开始监听.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Setup the TCP listening socket</span></span><br><span class="line">iResult = <span class="built_in">bind</span>(ListenSocket, result-&gt;ai_addr, (<span class="type">int</span>)result-&gt;ai_addrlen);</span><br><span class="line"><span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bind failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    <span class="built_in">freeaddrinfo</span>(result);</span><br><span class="line">    <span class="built_in">closesocket</span>(ListenSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">iResult = <span class="built_in">listen</span>(ListenSocket, SOMAXCONN);</span><br><span class="line"><span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;listen failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    <span class="built_in">closesocket</span>(ListenSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监听的端口可以接受来自 <code>socket</code> 的连接, 并返回新的文件描述符, 之后就可以在这个文件描述符上操作了. 注意此时的 <code>ClientSocket</code> 与 <code>ListenSocket</code> 并不相同. 建立起连接后, 原先的 <code>ListenSocket</code> 还可以重新接受新的连接. 而此时 <code>accept</code> 的特殊行为 (比如没有客户端连接时是直接返回错误还是阻塞等待) 是可以定义的, 由此衍生出一大堆例如多路复用的理论, 暂且不在这里讨论.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Accept a client socket</span></span><br><span class="line">ClientSocket = <span class="built_in">accept</span>(ListenSocket, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (ClientSocket == INVALID_SOCKET) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;accept failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    <span class="built_in">closesocket</span>(ListenSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿到的 <code>ClientSocket</code> 可以看作是一个文件描述符, 在这个文件描述符上可以写入也可以读取, 设置好缓冲区就行. 但是网络通讯受到通信协议的影响, 未必是想读多长就有多长, 因此返回值作为长度或者调用成功与否的标记非常重要.</p>
<p>完整的 Server 端代码如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #include &lt;windows.h&gt;</span></span><br><span class="line"><span class="comment">// #include &lt;winsock2.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_BUFLEN 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_PORT <span class="string">&quot;6000&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="type">int</span> iResult;</span><br><span class="line"></span><br><span class="line">    SOCKET ListenSocket = INVALID_SOCKET;</span><br><span class="line">    SOCKET ClientSocket = INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">addrinfo</span> *result = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">addrinfo</span> hints;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> iSendResult;</span><br><span class="line">    <span class="type">char</span> recvbuf[DEFAULT_BUFLEN];</span><br><span class="line">    <span class="type">int</span> recvbuflen = DEFAULT_BUFLEN;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initialize Winsock</span></span><br><span class="line">    iResult = <span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>,<span class="number">2</span>), &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;hints, <span class="built_in">sizeof</span>(hints));</span><br><span class="line">    hints.ai_family = AF_INET;</span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">    hints.ai_protocol = IPPROTO_TCP;</span><br><span class="line">    hints.ai_flags = AI_PASSIVE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve the server address and port</span></span><br><span class="line">    iResult = <span class="built_in">getaddrinfo</span>(<span class="literal">NULL</span>, DEFAULT_PORT, &amp;hints, &amp;result);</span><br><span class="line">    <span class="keyword">if</span> ( iResult != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getaddrinfo failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a SOCKET for the server to listen for client connections.</span></span><br><span class="line">    ListenSocket = <span class="built_in">socket</span>(result-&gt;ai_family, result-&gt;ai_socktype, result-&gt;ai_protocol);</span><br><span class="line">    <span class="keyword">if</span> (ListenSocket == INVALID_SOCKET) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;socket failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">freeaddrinfo</span>(result);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the TCP listening socket</span></span><br><span class="line">    iResult = <span class="built_in">bind</span>(ListenSocket, result-&gt;ai_addr, (<span class="type">int</span>)result-&gt;ai_addrlen);</span><br><span class="line">    <span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">freeaddrinfo</span>(result);</span><br><span class="line">        <span class="built_in">closesocket</span>(ListenSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">freeaddrinfo</span>(result);</span><br><span class="line"></span><br><span class="line">    iResult = <span class="built_in">listen</span>(ListenSocket, SOMAXCONN);</span><br><span class="line">    <span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;listen failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(ListenSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Accept a client socket</span></span><br><span class="line">    ClientSocket = <span class="built_in">accept</span>(ListenSocket, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ClientSocket == INVALID_SOCKET) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;accept failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(ListenSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No longer need server socket</span></span><br><span class="line">    <span class="built_in">closesocket</span>(ListenSocket);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Receive until the peer shuts down the connection</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">        iResult = <span class="built_in">recv</span>(ClientSocket, recvbuf, recvbuflen, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (iResult &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Bytes received: %s\n&quot;</span>, recvbuf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Echo the buffer back to the sender</span></span><br><span class="line">            iSendResult = <span class="built_in">send</span>( ClientSocket, recvbuf, iResult, <span class="number">0</span> );</span><br><span class="line">            <span class="keyword">if</span> (iSendResult == SOCKET_ERROR) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;send failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">                <span class="built_in">closesocket</span>(ClientSocket);</span><br><span class="line">                <span class="built_in">WSACleanup</span>();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Bytes sent: %d\n&quot;</span>, iSendResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (iResult == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Connection closing...\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span>  &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">            <span class="built_in">closesocket</span>(ClientSocket);</span><br><span class="line">            <span class="built_in">WSACleanup</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (iResult &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shutdown the connection since we&#x27;re done</span></span><br><span class="line">    iResult = <span class="built_in">shutdown</span>(ClientSocket, SD_SEND);</span><br><span class="line">    <span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;shutdown failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(ClientSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cleanup</span></span><br><span class="line">    <span class="built_in">closesocket</span>(ClientSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Client">Client</h3>
<p>Client 的总体思路和 Server 基本一样, 不过作为发起连接的客户, 我们必须要设置对方的 <code>IP</code>, 并尝试 <code>getaddrinfo</code> 返回链表上的每一个 <code>addrinfo</code>. 总体来说, 流程就是 Server 设置好自己的 <code>socket</code> 并开始 <code>listen</code>, 等到 Client 发起 <code>connect</code> 后 <code>accept</code> 这个连接. 如果这个过程没有出问题, 两方的连接就正式建立好了, 在各自的文件描述符上读写即可.</p>
<p>完整的 Client 代码如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment (lib, <span class="string">&quot;Ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_BUFLEN 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_PORT <span class="string">&quot;6000&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    SOCKET ConnectSocket = INVALID_SOCKET;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">addrinfo</span> *result = <span class="literal">NULL</span>,</span><br><span class="line">                    *ptr = <span class="literal">NULL</span>,</span><br><span class="line">                    hints;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *sendbuf = <span class="string">&quot;this is a test&quot;</span>;</span><br><span class="line">    <span class="type">char</span> recvbuf[DEFAULT_BUFLEN];</span><br><span class="line">    <span class="type">int</span> iResult;</span><br><span class="line">    <span class="type">int</span> recvbuflen = DEFAULT_BUFLEN;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initialize Winsock</span></span><br><span class="line">    iResult = <span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>,<span class="number">2</span>), &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ZeroMemory</span>( &amp;hints, <span class="built_in">sizeof</span>(hints) );</span><br><span class="line">    hints.ai_family = AF_UNSPEC;</span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">    hints.ai_protocol = IPPROTO_TCP;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve the server address and port</span></span><br><span class="line">    iResult = <span class="built_in">getaddrinfo</span>(<span class="string">&quot;127.0.0.1&quot;</span>, DEFAULT_PORT, &amp;hints, &amp;result);</span><br><span class="line">    <span class="keyword">if</span> ( iResult != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getaddrinfo failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attempt to connect to an address until one succeeds</span></span><br><span class="line">    <span class="keyword">for</span>(ptr=result; ptr != <span class="literal">NULL</span> ;ptr=ptr-&gt;ai_next) &#123;</span><br><span class="line">        <span class="comment">// Create a SOCKET for connecting to server</span></span><br><span class="line">        ConnectSocket = <span class="built_in">socket</span>(ptr-&gt;ai_family, ptr-&gt;ai_socktype, </span><br><span class="line">            ptr-&gt;ai_protocol);</span><br><span class="line">        <span class="keyword">if</span> (ConnectSocket == INVALID_SOCKET) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;socket failed with error: %ld\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">            <span class="built_in">WSACleanup</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Connect to server.</span></span><br><span class="line">        iResult = <span class="built_in">connect</span>( ConnectSocket, ptr-&gt;ai_addr, (<span class="type">int</span>)ptr-&gt;ai_addrlen);</span><br><span class="line">        <span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">            <span class="built_in">closesocket</span>(ConnectSocket);</span><br><span class="line">            ConnectSocket = INVALID_SOCKET;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">freeaddrinfo</span>(result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ConnectSocket == INVALID_SOCKET) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unable to connect to server!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send an initial buffer</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;OK\n&quot;</span>);</span><br><span class="line">    iResult = <span class="built_in">send</span>( ConnectSocket, sendbuf, (<span class="type">int</span>)<span class="built_in">strlen</span>(sendbuf), <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span> (iResult == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="built_in">closesocket</span>(ConnectSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Bytes Sent: %ld\n&quot;</span>, iResult);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Receive until the peer closes the connection</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        iResult = <span class="built_in">recv</span>(ConnectSocket, recvbuf, recvbuflen, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( iResult &gt; <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Bytes received: %s\n&quot;</span>, recvbuf);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( iResult == <span class="number">0</span> )</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Connection closed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv failed with error: %d\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">        <span class="type">char</span> str[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">        iResult = <span class="built_in">send</span>( ConnectSocket, str, (<span class="type">int</span>)<span class="built_in">strlen</span>(str) + <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125; <span class="keyword">while</span>( iResult &gt; <span class="number">0</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cleanup</span></span><br><span class="line">    <span class="built_in">closesocket</span>(ConnectSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里多插一句, windows 下的 <code>Ws2_32.lib</code> 库需要显式调用, 每次 <code>WSAStartup()</code> 相当于对这个库的引用计数加一, <code>WSACleanup()</code> 则减少一次引用, 引用为零时释放资源.</p>
</blockquote>
<h2 id="libevent-与-http-server-示例">libevent 与 http server 示例</h2>
<p>如果手工控制这些流程, 说实话有些繁琐, 而且稍有不慎就容易造成内存泄漏, 何况这只是 <code>TCP</code> 最简单的连接. 作为开发人员, 了解通信的每个步骤确实重要, 而实现业务目的才是根本要求. 这里要介绍的是 <code>libevent</code>, 它将底层的网络协议封装为事件驱动的函数调用, 开发者只要关注在不同事件触发时所需的行为, 大大简化了编码的流程.</p>
<h3 id="事件驱动与-reactor">事件驱动与 reactor</h3>
<p>在我浅薄的理解里, reactor 框架和事件驱动是紧紧关联的, 也就是代码需要设立触发的条件(event), 并设置好条件下的行为 (reactor). 这里的事件往往是不可预测时机的, 比如 server 开了端口并在监听, 谁也不知道 client 什么时候会来连接. 最傻逼的方法就是盲等, 我可以阻塞在这里, client 不来这个进程就挂在这儿了, 无法继续执行, 也可以不来就直接返回不成功, 我循环调用直到成功为止. 这都是用户层能做的事. 而底层操作系统有自己的办法(信号), 通过一些奇技淫巧, 我们可以让一个<strong>进程</strong>持续监听多个连接, 也可以直接挂起(切换到别的<strong>线程</strong>), 直到一个连接到来的信号重新唤醒它. 这样的事件推动着代码往下执行, 而对事件的反应是至关重要的.</p>
<p>至于条件的等待以及等待时如何节约资源, 这部分很大依赖于操作系统的内核 (系统调用的部分). 而不同的系统有自己的系统调用, 比如 windows 就不支持大名鼎鼎的 <code>epoll</code>, 因此想自己写通用的高效底层代码也是不现实的, 这就是底层封装的好处——<code>libevent</code>会根据系统自动选择最高效的底层实现.</p>
<p><code>libevent</code> 的精髓在于 <code>callback</code>, 中文叫回调函数, 在编程中我们只管定义特殊事件下调用的函数长什么样, 然后把其他活交个 <code>libevent</code> 就好 (<code>XXX_dispatch()</code>).</p>
<h3 id="http-server">http server</h3>
<p>这是一个 <code>libevent</code> 官方的例子, 运行起来后我们指定端口与根文件夹 (http-server.exe -p 8888 D:\html), 即可实现简单的本地服务器 (访问 127.0.0.1:8888/index.html).</p>
<p>示例的代码很长, 我不想在这里浪费空间, 所以我只是列出主要的函数名</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Callback used for the /dump URI, and for every non-GET request:</span></span><br><span class="line"><span class="comment"> * dumps all information to stdout and gives back a trivial 200 ok */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">dump_request_cb</span><span class="params">(<span class="keyword">struct</span> evhttp_request *req, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This callback gets invoked when we get any http request that doesn&#x27;t match</span></span><br><span class="line"><span class="comment"> * any other callback.  Like any evhttp server callback, it has a simple job:</span></span><br><span class="line"><span class="comment"> * it must eventually call evhttp_send_error() or evhttp_send_reply().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">send_document_cb</span><span class="params">(<span class="keyword">struct</span> evhttp_request *req, <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    base = <span class="built_in">event_base_new_with_config</span>(cfg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    http = <span class="built_in">evhttp_new</span>(base);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The /dump URI will dump all requests to stdout and say 200 ok. */</span></span><br><span class="line">    <span class="built_in">evhttp_set_cb</span>(http, <span class="string">&quot;/dump&quot;</span>, dump_request_cb, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We want to accept arbitrary requests, so we need to set a &quot;generic&quot;</span></span><br><span class="line"><span class="comment">     * cb.  We can also add callbacks for specific paths. */</span></span><br><span class="line">    <span class="built_in">evhttp_set_gencb</span>(http, send_document_cb, &amp;o);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    handle = <span class="built_in">evhttp_bind_socket_with_handle</span>(http, <span class="string">&quot;0.0.0.0&quot;</span>, o.port);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    term = <span class="built_in">evsignal_new</span>(base, SIGINT, (<span class="built_in">void</span> (*)(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>, <span class="type">short</span> <span class="type">int</span>, <span class="type">void</span>*))do_term, base);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">event_base_dispatch</span>(base);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看出, 我们设置了访问具体 <code>URL</code> 时发送内容的回调函数, 而在主程序中建立一个 <code>http</code> 对象并与回调函数关联, 最后我们直接将对象绑定到了 <code>ip:port</code> 上并开始了任务. 细碎的 <code>socket</code> 操作都由系统完成了.</p>
<h3 id="一个例子">一个例子</h3>
<p>这里我们着重来看一下 <code>evhttp_bind_socket_with_handle()</code> 函数, 并探讨其他的等效实现方式. 函数接收一个 <code>event</code> 对象, 并与指定的 IP 和端口绑定, 并返回文件描述符.</p>
<p>我们可以拆分成两部分, 先建立一个监听指定IP和端口的 <code>socket</code>, 然后把这个 <code>socket</code> 接收来自 <code>event</code> 对象的信息.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">std::string address = <span class="string">&quot;0.0.0.0:9000&quot;</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_storage</span> sa;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr</span>* addr = <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">struct</span> sockaddr*&gt;(&amp;sa);</span><br><span class="line"><span class="type">int</span> len = <span class="built_in">sizeof</span>(sa);</span><br><span class="line"><span class="built_in">evutil_parse_sockaddr_port</span>(address.<span class="built_in">c_str</span>(), addr, &amp;len);</span><br><span class="line"></span><br><span class="line">base = <span class="built_in">event_base_new</span>();</span><br><span class="line"><span class="keyword">auto</span> lev = <span class="built_in">evconnlistener_new_bind</span>(base, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">    LEV_OPT_CLOSE_ON_FREE | LEV_OPT_BIND_IPV4_AND_IPV6, <span class="number">-1</span>,</span><br><span class="line">    (<span class="keyword">struct</span> sockaddr *)addr, <span class="built_in">sizeof</span>(sockaddr_storage));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!lev) &#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;Cannot create listener&quot;</span>);</span><br><span class="line">    ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">handle = <span class="built_in">evhttp_bind_listener</span>(http, lev);</span><br></pre></td></tr></table></figure>
<p>可以看到, 我们能把封装的函数拆成更细的部分, 并有更多自定义的空间 (比如这里我们设置了双栈支持), <code>libevent</code> 在各个层次上都实现了封装.</p>
<h3 id="纯粹的底层实现">纯粹的底层实现</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">addrinfo</span> *result = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">addrinfo</span> hints;</span><br><span class="line"><span class="built_in">ZeroMemory</span>(&amp;hints, <span class="built_in">sizeof</span>(hints));</span><br><span class="line">hints.ai_family = AF_INET;</span><br><span class="line">hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">hints.ai_protocol = IPPROTO_TCP;</span><br><span class="line">hints.ai_flags = AI_PASSIVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resolve the server address and port</span></span><br><span class="line"><span class="type">int</span> iResult = <span class="built_in">getaddrinfo</span>(<span class="literal">NULL</span>, <span class="string">&quot;9000&quot;</span>, &amp;hints, &amp;result);</span><br><span class="line"><span class="keyword">if</span> ( iResult != <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;getaddrinfo failed with error: %d\n&quot;</span>, iResult);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a SOCKET for the server to listen for client connections.</span></span><br><span class="line"><span class="type">int</span> fd = <span class="built_in">socket</span>(result-&gt;ai_family, result-&gt;ai_socktype, result-&gt;ai_protocol);</span><br><span class="line"><span class="built_in">evutil_make_socket_nonblocking</span>(fd);</span><br><span class="line"><span class="built_in">evutil_make_listen_socket_reuseable</span>(fd);</span><br><span class="line"><span class="comment">// int off = 0;</span></span><br><span class="line"><span class="comment">// setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;off, (ev_socklen_t)sizeof(off));</span></span><br><span class="line"><span class="type">int</span> on =<span class="number">1</span>;</span><br><span class="line"><span class="built_in">setsockopt</span>(fd, SOL_SOCKET, SO_KEEPALIVE, (<span class="type">char</span>*)&amp;on, <span class="built_in">sizeof</span>(on));</span><br><span class="line"><span class="keyword">if</span> (fd == INVALID_SOCKET) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;socket failed with error: %ld\n&quot;</span>, <span class="built_in">WSAGetLastError</span>());</span><br><span class="line">    <span class="built_in">freeaddrinfo</span>(result);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> res=<span class="built_in">bind</span>(fd, result-&gt;ai_addr, (<span class="type">int</span>)result-&gt;ai_addrlen);</span><br><span class="line"><span class="keyword">if</span> (res != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bind error!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">listen</span>(fd, <span class="number">0x7fffffff</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;listen error!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">handle = <span class="built_in">evhttp_accept_socket_with_handle</span>(http, fd);</span><br></pre></td></tr></table></figure>
<h1>参考链接</h1>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/winsock/complete-server-code">https://learn.microsoft.com/zh-cn/windows/win32/winsock/complete-server-code</a></p>
<p><a target="_blank" rel="noopener" href="https://opensource.apple.com/source/ntp/ntp-124/sntp/libevent/include/event2/http.h.auto.html">https://opensource.apple.com/source/ntp/ntp-124/sntp/libevent/include/event2/http.h.auto.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.zhuoyuan-he.cn">Herbert</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.zhuoyuan-he.cn/Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/">https://www.zhuoyuan-he.cn/Socket编程基础/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.zhuoyuan-he.cn" target="_blank">H的部落阁</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C++</a></div><div class="post_share"><div class="social-share" data-image="/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/vPro%E4%B8%8EAMT/"><img class="next-cover" src="/linear-gradient(20deg,%20#0062be,%20#925696,%20#cc426e,%20#fb0347)" onerror="onerror=null;src='/imgs/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">vPro与AMT</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/imgs/selfie.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Herbert</div><div class="author-info__description">A soul discarded</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/herbyuan"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/herbyuan" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:herbyuan@icloud.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Eventually you come...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Socket编程基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#echo-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.1.</span> <span class="toc-text">echo 客户端与服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Server"><span class="toc-number">1.1.1.</span> <span class="toc-text">Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Client"><span class="toc-number">1.1.2.</span> <span class="toc-text">Client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libevent-%E4%B8%8E-http-server-%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.</span> <span class="toc-text">libevent 与 http server 示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E4%B8%8E-reactor"><span class="toc-number">1.2.1.</span> <span class="toc-text">事件驱动与 reactor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-server"><span class="toc-number">1.2.2.</span> <span class="toc-text">http server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.3.</span> <span class="toc-text">一个例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%AF%E7%B2%B9%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.4.</span> <span class="toc-text">纯粹的底层实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/Socket%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" title="Socket编程基础">Socket编程基础</a><time datetime="2024-01-24T08:51:13.000Z" title="发表于 2024-01-24 16:51:13">2024-01-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/vPro%E4%B8%8EAMT/" title="vPro与AMT">vPro与AMT</a><time datetime="2023-10-05T14:51:33.000Z" title="发表于 2023-10-05 22:51:33">2023-10-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/PHP-Mysql%E4%B8%8EOpenSSL/" title="PHP Mysql与OpenSSL">PHP Mysql与OpenSSL</a><time datetime="2023-07-27T01:32:50.000Z" title="发表于 2023-07-27 09:32:50">2023-07-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/Sublime-Text%E5%BC%80%E5%90%AFmarkdown%E9%A2%84%E8%A7%88/" title="Sublime_Text开启markdown预览">Sublime_Text开启markdown预览</a><time datetime="2023-07-25T07:05:08.000Z" title="发表于 2023-07-25 15:05:08">2023-07-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%95%85%E4%BA%8B%E4%B8%80%E5%88%99-0713/" title="故事一则 0713">故事一则 0713</a><time datetime="2023-07-13T11:25:51.000Z" title="发表于 2023-07-13 19:25:51">2023-07-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Herbert</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><span><img src="/imgs/gongan.png"><a href= "https://beian.mps.gov.cn/#/query/webSearch?code=11010802043161\" rel=\"noreferrer\" target=\"_blank\">京公网安备11010802043161</a ></span><span class="footer-separator">|</span><span><a href="https://beian.miit.gov.cn/" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;" target="_blank">京ICP备2023024480号-1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div></div></body></html>